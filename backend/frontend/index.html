<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#b20054; --brand-dark:#82003d;
      --bg:#f4f5f7; --card:#fff; --thead:#fde7f3;
      --border:#e5e7eb; --muted:#6b7280;
      --green:#0f9d58; --red:#c5221f;
      --green-soft:#e8f5ee; --red-soft:#fde8e7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Segoe UI',system-ui,Arial,sans-serif;color:#111827}
    .container{max-width:1100px;margin:28px auto;background:var(--card);border-radius:18px;box-shadow:0 8px 36px #d0c6db42;padding:8px 0 24px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:18px 24px 8px}
    h1{margin:0;color:var(--brand);font-size:2rem;font-weight:800}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:.95rem;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .box{padding:12px 24px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,input[type="date"]{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .muted{color:var(--muted);font-size:.9rem}
    .summary{display:flex;gap:16px;align-items:center;font-weight:700}
    .summary .in{color:var(--green)} .summary .out{color:var(--red)} .summary .bal{color:#111827}

    .table-wrap{margin-top:12px;border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;background:#fff}
    table{width:100%;min-width:980px;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--thead);color:var(--brand);text-align:left;font-weight:700;padding:10px;border-bottom:1px solid #f2c6df;z-index:1}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;white-space:nowrap}
    tbody tr:hover{filter:brightness(.98)}
    /* –∑–µ–±—Ä–∞ –¢–û–õ–¨–ö–û –¥–ª—è –±—É–¥—É—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π */
    tr.future.income{background:var(--green-soft)}
    tr.future.expense{background:var(--red-soft)}
    .op.plus{color:var(--green);font-weight:700}
    .op.minus{color:var(--red);font-weight:700}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.78rem;margin-left:6px}
    .actions{display:flex;gap:8px}
    .iconbtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
    .iconbtn:hover{background:#f9fafb}
    .link{color:var(--brand);cursor:pointer;text-decoration:underline}
    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start}
      .table-wrap{max-height:60vh}
      select,input[type="date"]{width:100%}
    }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal-back{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:14px;min-width:320px;max-width:700px;width:90%;padding:16px;box-shadow:0 20px 60px #00000040}
    .modal h3{margin:0 0 10px 0;color:#111827}
    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .form .field{display:flex;flex-direction:column;gap:6px}
    .form input,.form select,.form textarea{padding:10px;border:1px solid var(--border);border-radius:10px}
    .form textarea{grid-column:1/-1;min-height:60px}
    .modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .note{font-size:.9rem;color:var(--muted)}

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏/—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ */
    .settings{display:none;margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:12px}
    .settings h4{margin:0 0 8px 0}
    .settings .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .settings textarea{width:100%;min-height:80px;border:1px solid var(--border);border-radius:10px;padding:8px}
    @media (max-width:900px){ .form{grid-template-columns:1fr} .settings .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</h1>
      <div class="row">
        <button id="settingsBtn" class="btn secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
      </div>
    </header>

    <div class="box">
      <div class="row">
        <select id="opFilter">
          <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
          <option value="income">–¢–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥—ã</option>
          <option value="expense">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</option>
          <option value="planned">–ü–ª–∞–Ω (–±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)</option>
        </select>

        <select id="cashFilter">
          <option value="all">–í—Å–µ –∫–∞—Å—Å—ã</option>
        </select>

        <input type="date" id="dateFrom" />
        <input type="date" id="dateTo" />
        <button id="resetBtn" class="btn secondary">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>

        <div class="summary" style="margin-left:auto">
          <span class="in">–î–æ—Ö–æ–¥: <span id="sumIn">0 ‚ÇΩ</span></span> ‚Ä¢
          <span class="out">–†–∞—Å—Ö–æ–¥: <span id="sumOut">0 ‚ÇΩ</span></span> ‚Ä¢
          <span class="bal">–ë–∞–ª–∞–Ω—Å: <span id="sumBal">0 ‚ÇΩ</span></span>
        </div>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏) -->
      <div class="settings" id="settingsPanel">
        <h4>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ, –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)</h4>
        <div class="grid">
          <div><div class="note">–°—Ç–∞—Ç—å–∏</div><textarea id="dictCategory" placeholder="–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea></div>
          <div><div class="note">–ü—Ä–æ–µ–∫—Ç—ã</div><textarea id="dictProject" placeholder="–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea></div>
          <div><div class="note">–ö–∞—Å—Å—ã/–°—á–µ—Ç–∞</div><textarea id="dictCashbox" placeholder="–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea></div>
          <div><div class="note">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã (–∫–æ–º–ø–∞–Ω–∏–∏/–∫–ª–∏–µ–Ω—Ç—ã/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)</div><textarea id="dictContractor" placeholder="–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="saveDicts" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span class="note">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage. –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.</span>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
              <th>–°—Ç–∞—Ç—å—è/–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th>–°–¥–µ–ª–∫–∞</th>
              <th>–ü—Ä–æ–µ–∫—Ç</th>
              <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
              <th>–°—á—ë—Ç/–∫–∞—Å—Å—ã</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:8px">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="count">0</span></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div class="modal-back" id="formBack">
    <div class="modal">
      <h3 id="formTitle">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h3>
      <form id="editForm" class="form">
        <div class="field"><label>–î–∞—Ç–∞</label><input type="date" name="date" required></div>
        <div class="field"><label>–°—É–º–º–∞</label><input type="number" name="amount" step="0.01" required></div>
        <div class="field"><label>–°—Ç–∞—Ç—å—è</label><select name="category" id="selCategory"></select></div>
        <div class="field"><label>–ü—Ä–æ–µ–∫—Ç</label><select name="project" id="selProject"></select></div>
        <div class="field"><label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label><select name="company_name" id="selContractor"></select></div>
        <div class="field"><label>–°—á—ë—Ç/–∫–∞—Å—Å–∞</label><select name="cashbox" id="selCashbox"></select></div>
        <div class="field" style="grid-column:1/-1"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea name="comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></textarea></div>
      </form>
      <div class="footer">
        <button id="formCancel" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
        <button id="formSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–≤—è–∑–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å -->
  <div class="modal-back" id="bitrixBack">
    <div class="modal">
      <h3>–°–≤—è–∑–∞—Ç—å —Å –ë–∏—Ç—Ä–∏–∫—Å</h3>
      <div class="note" style="margin-bottom:8px">–í–≤–µ–¥–∏—Ç–µ <b>ID —Å–¥–µ–ª–∫–∏</b>. (–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø–æ–¥–∫–ª—é—á–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º.)</div>
      <div class="field"><label>ID —Å–¥–µ–ª–∫–∏</label><input id="dealIdInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1234"></div>
      <div class="footer">
        <button id="bitrixCancel" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
        <button id="bitrixLink" class="btn">–°–≤—è–∑–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // --- API ---
    const API = {
      list:'/payments',
      create:'/payments',
      update:id=>`/payments/${id}`,
      remove:id=>`/payments/${id}`,
      patch:id=>`/payments/${id}/link`,
      linkBitrix:id=>`/payments/${id}/link/bitrix`,
    };

    // --- helpers ---
    const el = s => document.querySelector(s);
    const fmtMoney = n => {
      const v = Number(n);
      if (Number.isNaN(v)) return String(n ?? '');
      return v.toLocaleString('ru-RU',{minimumFractionDigits:0, maximumFractionDigits:2}) + ' ‚ÇΩ';
    };
    const fmtDate = s => {
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return String(s);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    };
    const toISO = s => { try{ return s ? new Date(s).toISOString().slice(0,10) : ''; }catch{ return ''; } };
    const isFuture = s => {
      if (!s) return false;
      const d = new Date(s);
      if (isNaN(d)) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      return d.getTime() > today.getTime();
    };
    function loadDict(k){ try{ return JSON.parse(localStorage.getItem('dict_'+k) || '[]'); }catch{ return []; } }
    function saveDict(k,arr){ localStorage.setItem('dict_'+k, JSON.stringify(arr)); }
    function fillSelect(select, arr, allowEmpty=true){
      select.innerHTML = allowEmpty ? '<option value="">‚Äî</option>' : '';
      arr.forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o);
      });
    }

    // --- state & refs ---
    let all = [];
    let filtered = [];
    let editingId = null;
    let bitrixTargetId = null;

    const tbody = el('#tbody');
    const countEl = el('#count');
    const sumInEl = el('#sumIn');
    const sumOutEl = el('#sumOut');
    const sumBalEl = el('#sumBal');
    const opFilter = el('#opFilter');
    const cashFilter = el('#cashFilter');
    const dateFrom = el('#dateFrom');
    const dateTo = el('#dateTo');
    const resetBtn = el('#resetBtn');
    const addBtn = el('#addBtn');
    const settingsBtn = el('#settingsBtn');
    const settingsPanel = el('#settingsPanel');
    const tCategory = el('#dictCategory');
    const tProject = el('#dictProject');
    const tCashbox = el('#dictCashbox');
    const tContractor = el('#dictContractor');
    const saveDictsBtn = el('#saveDicts');

    const formBack = el('#formBack');
    const formTitle = el('#formTitle');
    const editForm = el('#editForm');
    const formCancel = el('#formCancel');
    const formSave = el('#formSave');
    const selCategory = el('#selCategory');
    const selProject = el('#selProject');
    const selContractor = el('#selContractor');
    const selCashbox = el('#selCashbox');

    const bitrixBack = el('#bitrixBack');
    const bitrixCancel = el('#bitrixCancel');
    const bitrixLink = el('#bitrixLink');
    const dealIdInput = el('#dealIdInput');

    // --- Settings panel ---
    settingsBtn.onclick = () => {
      const hiddenNow = getComputedStyle(settingsPanel).display === 'none';
      const cat  = loadDict('category');
      const proj = loadDict('project');
      const cash = loadDict('cashbox');
      const cont = loadDict('contractor');
      tCategory.value   = cat.join('\n');
      tProject.value    = proj.join('\n');
      tCashbox.value    = cash.join('\n');
      tContractor.value = cont.join('\n');
      settingsPanel.style.display = hiddenNow ? '' : 'none';
      // –æ–±–Ω–æ–≤–∏–º —Å–µ–ª–µ–∫—Ç—ã —Ñ–æ—Ä–º—ã, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –±—ã–ª–∏ –ø–æ–¥ —Ä—É–∫–æ–π
      fillSelect(selCategory,  cat);
      fillSelect(selProject,   proj);
      fillSelect(selCashbox,   cash);
      fillSelect(selContractor,cont);
    };

    saveDictsBtn.onclick = ()=>{
      const norm = s => String(s||'').split('\n').map(x=>x.trim()).filter(Boolean);
      saveDict('category',  norm(tCategory.value));
      saveDict('project',   norm(tProject.value));
      saveDict('cashbox',   norm(tCashbox.value));
      saveDict('contractor',norm(tContractor.value));
      alert('–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      settingsPanel.style.display='none';
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
    };

    // --- filters ---
    opFilter.onchange = render;
    cashFilter.onchange = render;
    dateFrom.onchange = render;
    dateTo.onchange = render;
    resetBtn.onclick = ()=>{
      opFilter.value='all'; cashFilter.value='all'; dateFrom.value=''; dateTo.value='';
      render();
    };

    // --- Add/Edit ---
    addBtn.onclick = ()=>{
      editingId = null;
      formTitle.textContent = '–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è';
      editForm.reset();
      editForm.elements['date'].value = new Date().toISOString().slice(0,10);
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
      formBack.style.display='flex';
    };
    formCancel.onclick = ()=> formBack.style.display='none';
    formSave.onclick = async ()=>{
      const fd = new FormData(editForm);
      const obj = {}; fd.forEach((v,k)=>{ if(String(v).trim()!=='') obj[k]=v; });
      if (obj.amount!==undefined) obj.amount = Number(obj.amount);
      try{
        let r;
        if (editingId==null){
          r = await fetch(API.create,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj) });
        } else {
          r = await fetch(API.update(editingId),{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj) });
        }
        if (!r.ok){ const t=await r.text(); console.error(t); alert('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å'); return; }
        formBack.style.display='none'; await load();
      }catch{ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    };

    // --- Bitrix modal ---
    function openBitrix(id){ bitrixTargetId = id; dealIdInput.value=''; bitrixBack.style.display='flex'; }
    bitrixCancel.onclick = ()=> bitrixBack.style.display='none';

    bitrixLink.onclick = async ()=>{
      const dealId = dealIdInput.value.trim();
      if (!dealId) { alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–¥–µ–ª–∫–∏'); return; }
      try{
        const r = await fetch(API.linkBitrix(bitrixTargetId), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ dealId })
        });
        const data = await r.json().catch(()=>null);

        if (!r.ok){
          const msg = (data && (data.error || data.message)) || '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å';
          console.error('Bitrix link error:', data || await r.text());
          alert(msg);
          return;
        }

        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É ‚Äî –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
        if (data && data.updated) {
          const idx = all.findIndex(x=>String(x.id)===String(data.updated.id));
          if (idx>=0) all[idx] = data.updated;
        }

        bitrixBack.style.display='none';
        await load();
      }catch(e){
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    };

    // --- table render ---
    function buildCashFilter(){
      const set = new Set(all.map(x=>x.cashbox).filter(Boolean));
      const current = cashFilter.value;
      cashFilter.innerHTML = '<option value="all">–í—Å–µ –∫–∞—Å—Å—ã</option>' +
        Array.from(set).sort().map(v=>`<option value="${v}">${v}</option>`).join('');
      if (Array.from(set).includes(current)) cashFilter.value=current;
    }

    function applyFilters(){
      const type = opFilter.value;
      const cash = cashFilter.value;
      const df = dateFrom.value ? new Date(dateFrom.value) : null;
      const dt = dateTo.value ? new Date(dateTo.value) : null;
      if (df) df.setHours(0,0,0,0);
      if (dt) dt.setHours(23,59,59,999);

      filtered = all.filter(x=>{
        const amt = Number(x.amount||0);
        const d = x.date ? new Date(x.date) : null;

        if (cash!=='all' && (x.cashbox||'')!==cash) return false;

        if (d){
          if (df && d < df) return false;
          if (dt && d > dt) return false;
        }

        const future = isFuture(x.date);
        if (type==='income' && !(amt>0)) return false;
        if (type==='expense' && !(amt<0)) return false;
        if (type==='planned' && !future) return false;

        return true;
      });
    }

    function renderTable(){
      tbody.innerHTML='';
      let sumIn=0,sumOut=0;

      filtered.forEach(row=>{
        const tr = document.createElement('tr');

        const future = isFuture(row.date);
        const amt = Number(row.amount||0);
        if (future) tr.classList.add('future', amt>=0 ? 'income' : 'expense');

        // –¥–∞—Ç–∞ + –±–µ–π–¥–∂ "–ø–ª–∞–Ω"
        const tdDate = document.createElement('td');
        tdDate.textContent = fmtDate(row.date);
        if (future){
          const b = document.createElement('span'); b.className='badge'; b.textContent='–ø–ª–∞–Ω';
          tdDate.appendChild(b);
        }
        tr.appendChild(tdDate);

        // –æ–ø–µ—Ä–∞—Ü–∏—è
        const tdOp = document.createElement('td');
        if (amt>=0){ tdOp.className='op plus'; tdOp.textContent = '+ ' + fmtMoney(amt); sumIn+=amt; }
        else { tdOp.className='op minus'; tdOp.textContent = '- ' + fmtMoney(Math.abs(amt)); sumOut+=Math.abs(amt); }
        tr.appendChild(tdOp);

        // —Å—Ç–∞—Ç—å—è/–æ–ø–∏—Å–∞–Ω–∏–µ
        const tdArt = document.createElement('td');
        tdArt.textContent = row.category || row.comment || row.article || '';
        tr.appendChild(tdArt);

        // —Å–¥–µ–ª–∫–∞ (–ø–æ–∫–∞–∂–µ–º title –∏–ª–∏ —Ö–æ—Ç—è –±—ã "–°–¥–µ–ª–∫–∞ #ID")
        const tdDeal = document.createElement('td');
        const dealTitle = row.bitrix_title || (row.bitrix_deal_id ? `–°–¥–µ–ª–∫–∞ #${row.bitrix_deal_id}` : '');
        if (dealTitle) tdDeal.textContent = dealTitle;
        else tdDeal.innerHTML = '<span class="link">–°–≤—è–∑–∞—Ç—å‚Ä¶</span>';
        tdDeal.style.cursor='pointer';
        tdDeal.onclick = ()=> openBitrix(row.id);
        tr.appendChild(tdDeal);

        // –ø—Ä–æ–µ–∫—Ç
        const tdProj = document.createElement('td'); tdProj.textContent = row.project || ''; tr.appendChild(tdProj);

        // –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–∫–æ–º–ø–∞–Ω–∏—è/–∫–ª–∏–µ–Ω—Ç/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)
        const tdContr = document.createElement('td'); tdContr.textContent = row.company_name || row.contact_name || ''; tr.appendChild(tdContr);

        // –∫–∞—Å—Å–∞
        const tdCash = document.createElement('td'); tdCash.textContent = row.cashbox || ''; tr.appendChild(tdCash);

        // –¥–µ–π—Å—Ç–≤–∏—è
        const tdAct = document.createElement('td'); tdAct.className='actions';
        const btnEdit = document.createElement('button'); btnEdit.className='iconbtn'; btnEdit.title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; btnEdit.textContent='‚úèÔ∏è';
        btnEdit.onclick=()=> onEdit(row);
        const btnDel = document.createElement('button'); btnDel.className='iconbtn'; btnDel.title='–£–¥–∞–ª–∏—Ç—å'; btnDel.textContent='üóëÔ∏è';
        btnDel.onclick=()=> onDelete(row.id);
        tdAct.append(btnEdit, btnDel); tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });

      countEl.textContent = String(filtered.length);
      sumInEl.textContent = fmtMoney(sumIn);
      sumOutEl.textContent = fmtMoney(sumOut);
      sumBalEl.textContent = fmtMoney(sumIn - sumOut);
    }

    function render(){ applyFilters(); renderTable(); }

    // CRUD
    async function onDelete(id){
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å #' + id + '?')) return;
      try{
        const r = await fetch(API.remove(id), { method:'DELETE' });
        if (!r.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
        await load();
      }catch{ alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    function onEdit(row){
      editingId = row.id;
      formTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ #' + row.id;
      editForm.reset();
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
      editForm.elements['date'].value = row.date ? toISO(row.date) : '';
      editForm.elements['amount'].value = row.amount ?? '';
      editForm.elements['category'].value = row.category ?? '';
      editForm.elements['project'].value = row.project ?? '';
      editForm.elements['company_name'].value = row.company_name ?? '';
      editForm.elements['cashbox'].value = row.cashbox ?? '';
      editForm.elements['comment'].value = row.comment ?? '';
      formBack.style.display='flex';
    }

    // –∑–∞–≥—Ä—É–∑–∫–∞
    async function load(){
      tbody.innerHTML = '<tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
      try{
        const r = await fetch(API.list);
        const data = await r.json();
        all = Array.isArray(data) ? data : [];
        buildCashFilter();
        render();
      }catch(e){
        tbody.innerHTML = '<tr><td>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        console.error(e);
      }
    }

    // init
    load();
  </script>
</body>
</html>
