<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Финансы Сталкер</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#b20054; --brand-dark:#82003d;
      --bg:#f4f5f7; --card:#fff; --thead:#fde7f3;
      --border:#e5e7eb; --muted:#6b7280;
      --green:#0f9d58; --red:#c5221f;
      --green-soft:#e8f5ee; --red-soft:#fde8e7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Segoe UI',system-ui,Arial,sans-serif;color:#111827}
    .container{max-width:1100px;margin:28px auto;background:var(--card);border-radius:18px;box-shadow:0 8px 36px #d0c6db42;padding:8px 0 24px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:18px 24px 8px}
    h1{margin:0;color:var(--brand);font-size:2rem;font-weight:800}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:.95rem;cursor:pointer;transition:.15s}
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .box{padding:12px 24px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,input[type="date"]{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .muted{color:var(--muted);font-size:.9rem}
    .summary{display:flex;gap:16px;align-items:center;font-weight:700}
    .summary .in{color:var(--green)} .summary .out{color:var(--red)} .summary .bal{color:#111827}

    .table-wrap{margin-top:12px;border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;background:#fff}
    table{width:100%;min-width:980px;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--thead);color:var(--brand);text-align:left;font-weight:700;padding:10px;border-bottom:1px solid #f2c6df;z-index:1}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;white-space:nowrap}
    tbody tr:hover{filter:brightness(.98)}
    /* зебра ТОЛЬКО для будущих операций */
    tr.future.income{background:var(--green-soft)}
    tr.future.expense{background:var(--red-soft)}
    .op.plus{color:var(--green);font-weight:700}
    .op.minus{color:var(--red);font-weight:700}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.78rem;margin-left:6px}
    .actions{display:flex;gap:8px}
    .iconbtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
    .iconbtn:hover{background:#f9fafb}
    .link{color:var(--brand);cursor:pointer;text-decoration:underline}
    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start}
      .table-wrap{max-height:60vh}
      select,input[type="date"]{width:100%}
    }

    /* Модалки */
    .modal-back{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:14px;min-width:320px;max-width:700px;width:90%;padding:16px;box-shadow:0 20px 60px #00000040}
    .modal h3{margin:0 0 10px 0;color:#111827}
    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .form .field{display:flex;flex-direction:column;gap:6px}
    .form input,.form select,.form textarea{padding:10px;border:1px solid var(--border);border-radius:10px}
    .form textarea{grid-column:1/-1;min-height:60px}
    .modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .note{font-size:.9rem;color:var(--muted)}

    /* Настройки/справочники */
    .settings{display:none;margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:12px}
    .settings h4{margin:0 0 8px 0}
    .settings .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .settings textarea{width:100%;min-height:80px;border:1px solid var(--border);border-radius:10px;padding:8px}
    @media (max-width:900px){ .form{grid-template-columns:1fr} .settings .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Финансы Сталкер</h1>
      <div class="row">
        <button id="settingsBtn" class="btn secondary">Настройки</button>
        <button id="addBtn" class="btn">Добавить платёж</button>
      </div>
    </header>

    <div class="box">
      <div class="row">
        <select id="opFilter">
          <option value="all">Все операции</option>
          <option value="income">Только доходы</option>
          <option value="expense">Только расходы</option>
          <option value="planned">План (будущие даты)</option>
        </select>

        <select id="cashFilter">
          <option value="all">Все кассы</option>
        </select>

        <input type="date" id="dateFrom" />
        <input type="date" id="dateTo" />
        <button id="resetBtn" class="btn secondary">Сбросить фильтры</button>

        <div class="summary" style="margin-left:auto">
          <span class="in">Доход: <span id="sumIn">0 ₽</span></span> •
          <span class="out">Расход: <span id="sumOut">0 ₽</span></span> •
          <span class="bal">Баланс: <span id="sumBal">0 ₽</span></span>
        </div>
      </div>

      <!-- Панель настроек (локальные справочники) -->
      <div class="settings" id="settingsPanel">
        <h4>Справочники (локально, в этом браузере)</h4>
        <div class="grid">
          <div><div class="note">Статьи</div><textarea id="dictCategory" placeholder="каждая с новой строки"></textarea></div>
          <div><div class="note">Проекты</div><textarea id="dictProject" placeholder="каждая с новой строки"></textarea></div>
          <div><div class="note">Кассы/Счета</div><textarea id="dictCashbox" placeholder="каждая с новой строки"></textarea></div>
          <div><div class="note">Контрагенты (компании/клиенты/сотрудники)</div><textarea id="dictContractor" placeholder="каждый с новой строки"></textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="saveDicts" class="btn">Сохранить</button>
          <span class="note">Данные сохраняются в localStorage. Позже можно вынести в настройки сервера.</span>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Операция</th>
              <th>Статья/Описание</th>
              <th>Сделка</th>
              <th>Проект</th>
              <th>Контрагент</th>
              <th>Счёт/кассы</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:8px">Всего записей: <span id="count">0</span></div>
    </div>
  </div>

  <!-- Модалка добавления/редактирования -->
  <div class="modal-back" id="formBack">
    <div class="modal">
      <h3 id="formTitle">Новая операция</h3>
      <form id="editForm" class="form">
        <div class="field"><label>Дата</label><input type="date" name="date" required></div>
        <div class="field"><label>Сумма</label><input type="number" name="amount" step="0.01" required></div>
        <div class="field"><label>Статья</label><select name="category" id="selCategory"></select></div>
        <div class="field"><label>Проект</label><select name="project" id="selProject"></select></div>
        <div class="field"><label>Контрагент</label><select name="company_name" id="selContractor"></select></div>
        <div class="field"><label>Счёт/касса</label><select name="cashbox" id="selCashbox"></select></div>
        <div class="field" style="grid-column:1/-1"><label>Комментарий</label><textarea name="comment" placeholder="Опционально"></textarea></div>
      </form>
      <div class="footer">
        <button id="formCancel" class="btn secondary">Отмена</button>
        <button id="formSave" class="btn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Модалка связи с Битрикс -->
  <div class="modal-back" id="bitrixBack">
    <div class="modal">
      <h3>Связать с Битрикс</h3>
      <div class="note" style="margin-bottom:8px">Введите <b>ID сделки</b>. (Поиск по названию подключим следующим шагом.)</div>
      <div class="field"><label>ID сделки</label><input id="dealIdInput" type="text" placeholder="например, 1234"></div>
      <div class="footer">
        <button id="bitrixCancel" class="btn secondary">Отмена</button>
        <button id="bitrixLink" class="btn">Связать</button>
      </div>
    </div>
  </div>

  <script>
    // --- API ---
    const API = {
      list:'/payments',
      create:'/payments',
      update:id=>`/payments/${id}`,
      remove:id=>`/payments/${id}`,
      patch:id=>`/payments/${id}/link`,
      linkBitrix:id=>`/payments/${id}/link/bitrix`,
    };

    // --- helpers ---
    const el = s => document.querySelector(s);
    const fmtMoney = n => {
      const v = Number(n);
      if (Number.isNaN(v)) return String(n ?? '');
      return v.toLocaleString('ru-RU',{minimumFractionDigits:0, maximumFractionDigits:2}) + ' ₽';
    };
    const fmtDate = s => {
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return String(s);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    };
    const toISO = s => { try{ return s ? new Date(s).toISOString().slice(0,10) : ''; }catch{ return ''; } };
    const isFuture = s => {
      if (!s) return false;
      const d = new Date(s);
      if (isNaN(d)) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      return d.getTime() > today.getTime();
    };
    function loadDict(k){ try{ return JSON.parse(localStorage.getItem('dict_'+k) || '[]'); }catch{ return []; } }
    function saveDict(k,arr){ localStorage.setItem('dict_'+k, JSON.stringify(arr)); }
    function fillSelect(select, arr, allowEmpty=true){
      select.innerHTML = allowEmpty ? '<option value="">—</option>' : '';
      arr.forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o);
      });
    }

    // --- state & refs ---
    let all = [];
    let filtered = [];
    let editingId = null;
    let bitrixTargetId = null;

    const tbody = el('#tbody');
    const countEl = el('#count');
    const sumInEl = el('#sumIn');
    const sumOutEl = el('#sumOut');
    const sumBalEl = el('#sumBal');
    const opFilter = el('#opFilter');
    const cashFilter = el('#cashFilter');
    const dateFrom = el('#dateFrom');
    const dateTo = el('#dateTo');
    const resetBtn = el('#resetBtn');
    const addBtn = el('#addBtn');
    const settingsBtn = el('#settingsBtn');
    const settingsPanel = el('#settingsPanel');
    const tCategory = el('#dictCategory');
    const tProject = el('#dictProject');
    const tCashbox = el('#dictCashbox');
    const tContractor = el('#dictContractor');
    const saveDictsBtn = el('#saveDicts');

    const formBack = el('#formBack');
    const formTitle = el('#formTitle');
    const editForm = el('#editForm');
    const formCancel = el('#formCancel');
    const formSave = el('#formSave');
    const selCategory = el('#selCategory');
    const selProject = el('#selProject');
    const selContractor = el('#selContractor');
    const selCashbox = el('#selCashbox');

    const bitrixBack = el('#bitrixBack');
    const bitrixCancel = el('#bitrixCancel');
    const bitrixLink = el('#bitrixLink');
    const dealIdInput = el('#dealIdInput');

    // --- Settings panel ---
    settingsBtn.onclick = () => {
      const hiddenNow = getComputedStyle(settingsPanel).display === 'none';
      const cat  = loadDict('category');
      const proj = loadDict('project');
      const cash = loadDict('cashbox');
      const cont = loadDict('contractor');
      tCategory.value   = cat.join('\n');
      tProject.value    = proj.join('\n');
      tCashbox.value    = cash.join('\n');
      tContractor.value = cont.join('\n');
      settingsPanel.style.display = hiddenNow ? '' : 'none';
      // обновим селекты формы, чтобы новые значения были под рукой
      fillSelect(selCategory,  cat);
      fillSelect(selProject,   proj);
      fillSelect(selCashbox,   cash);
      fillSelect(selContractor,cont);
    };

    saveDictsBtn.onclick = ()=>{
      const norm = s => String(s||'').split('\n').map(x=>x.trim()).filter(Boolean);
      saveDict('category',  norm(tCategory.value));
      saveDict('project',   norm(tProject.value));
      saveDict('cashbox',   norm(tCashbox.value));
      saveDict('contractor',norm(tContractor.value));
      alert('Справочники сохранены');
      settingsPanel.style.display='none';
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
    };

    // --- filters ---
    opFilter.onchange = render;
    cashFilter.onchange = render;
    dateFrom.onchange = render;
    dateTo.onchange = render;
    resetBtn.onclick = ()=>{
      opFilter.value='all'; cashFilter.value='all'; dateFrom.value=''; dateTo.value='';
      render();
    };

    // --- Add/Edit ---
    addBtn.onclick = ()=>{
      editingId = null;
      formTitle.textContent = 'Новая операция';
      editForm.reset();
      editForm.elements['date'].value = new Date().toISOString().slice(0,10);
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
      formBack.style.display='flex';
    };
    formCancel.onclick = ()=> formBack.style.display='none';
    formSave.onclick = async ()=>{
      const fd = new FormData(editForm);
      const obj = {}; fd.forEach((v,k)=>{ if(String(v).trim()!=='') obj[k]=v; });
      if (obj.amount!==undefined) obj.amount = Number(obj.amount);
      try{
        let r;
        if (editingId==null){
          r = await fetch(API.create,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj) });
        } else {
          r = await fetch(API.update(editingId),{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj) });
        }
        if (!r.ok){ const t=await r.text(); console.error(t); alert('Сохранить не удалось'); return; }
        formBack.style.display='none'; await load();
      }catch{ alert('Ошибка сети'); }
    };

    // --- Bitrix modal ---
    function openBitrix(id){ bitrixTargetId = id; dealIdInput.value=''; bitrixBack.style.display='flex'; }
    bitrixCancel.onclick = ()=> bitrixBack.style.display='none';

    bitrixLink.onclick = async ()=>{
      const dealId = dealIdInput.value.trim();
      if (!dealId) { alert('Введите ID сделки'); return; }
      try{
        const r = await fetch(API.linkBitrix(bitrixTargetId), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ dealId })
        });
        const data = await r.json().catch(()=>null);

        if (!r.ok){
          const msg = (data && (data.error || data.message)) || 'Ошибка связи с Битрикс';
          console.error('Bitrix link error:', data || await r.text());
          alert(msg);
          return;
        }

        // Если сервер прислал обновлённую строку — обновим локально
        if (data && data.updated) {
          const idx = all.findIndex(x=>String(x.id)===String(data.updated.id));
          if (idx>=0) all[idx] = data.updated;
        }

        bitrixBack.style.display='none';
        await load();
      }catch(e){
        console.error(e);
        alert('Ошибка сети');
      }
    };

    // --- table render ---
    function buildCashFilter(){
      const set = new Set(all.map(x=>x.cashbox).filter(Boolean));
      const current = cashFilter.value;
      cashFilter.innerHTML = '<option value="all">Все кассы</option>' +
        Array.from(set).sort().map(v=>`<option value="${v}">${v}</option>`).join('');
      if (Array.from(set).includes(current)) cashFilter.value=current;
    }

    function applyFilters(){
      const type = opFilter.value;
      const cash = cashFilter.value;
      const df = dateFrom.value ? new Date(dateFrom.value) : null;
      const dt = dateTo.value ? new Date(dateTo.value) : null;
      if (df) df.setHours(0,0,0,0);
      if (dt) dt.setHours(23,59,59,999);

      filtered = all.filter(x=>{
        const amt = Number(x.amount||0);
        const d = x.date ? new Date(x.date) : null;

        if (cash!=='all' && (x.cashbox||'')!==cash) return false;

        if (d){
          if (df && d < df) return false;
          if (dt && d > dt) return false;
        }

        const future = isFuture(x.date);
        if (type==='income' && !(amt>0)) return false;
        if (type==='expense' && !(amt<0)) return false;
        if (type==='planned' && !future) return false;

        return true;
      });
    }

    function renderTable(){
      tbody.innerHTML='';
      let sumIn=0,sumOut=0;

      filtered.forEach(row=>{
        const tr = document.createElement('tr');

        const future = isFuture(row.date);
        const amt = Number(row.amount||0);
        if (future) tr.classList.add('future', amt>=0 ? 'income' : 'expense');

        // дата + бейдж "план"
        const tdDate = document.createElement('td');
        tdDate.textContent = fmtDate(row.date);
        if (future){
          const b = document.createElement('span'); b.className='badge'; b.textContent='план';
          tdDate.appendChild(b);
        }
        tr.appendChild(tdDate);

        // операция
        const tdOp = document.createElement('td');
        if (amt>=0){ tdOp.className='op plus'; tdOp.textContent = '+ ' + fmtMoney(amt); sumIn+=amt; }
        else { tdOp.className='op minus'; tdOp.textContent = '- ' + fmtMoney(Math.abs(amt)); sumOut+=Math.abs(amt); }
        tr.appendChild(tdOp);

        // статья/описание
        const tdArt = document.createElement('td');
        tdArt.textContent = row.category || row.comment || row.article || '';
        tr.appendChild(tdArt);

        // сделка (покажем title или хотя бы "Сделка #ID")
        const tdDeal = document.createElement('td');
        const dealTitle = row.bitrix_title || (row.bitrix_deal_id ? `Сделка #${row.bitrix_deal_id}` : '');
        if (dealTitle) tdDeal.textContent = dealTitle;
        else tdDeal.innerHTML = '<span class="link">Связать…</span>';
        tdDeal.style.cursor='pointer';
        tdDeal.onclick = ()=> openBitrix(row.id);
        tr.appendChild(tdDeal);

        // проект
        const tdProj = document.createElement('td'); tdProj.textContent = row.project || ''; tr.appendChild(tdProj);

        // контрагент (компания/клиент/сотрудник)
        const tdContr = document.createElement('td'); tdContr.textContent = row.company_name || row.contact_name || ''; tr.appendChild(tdContr);

        // касса
        const tdCash = document.createElement('td'); tdCash.textContent = row.cashbox || ''; tr.appendChild(tdCash);

        // действия
        const tdAct = document.createElement('td'); tdAct.className='actions';
        const btnEdit = document.createElement('button'); btnEdit.className='iconbtn'; btnEdit.title='Редактировать'; btnEdit.textContent='✏️';
        btnEdit.onclick=()=> onEdit(row);
        const btnDel = document.createElement('button'); btnDel.className='iconbtn'; btnDel.title='Удалить'; btnDel.textContent='🗑️';
        btnDel.onclick=()=> onDelete(row.id);
        tdAct.append(btnEdit, btnDel); tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });

      countEl.textContent = String(filtered.length);
      sumInEl.textContent = fmtMoney(sumIn);
      sumOutEl.textContent = fmtMoney(sumOut);
      sumBalEl.textContent = fmtMoney(sumIn - sumOut);
    }

    function render(){ applyFilters(); renderTable(); }

    // CRUD
    async function onDelete(id){
      if (!confirm('Удалить запись #' + id + '?')) return;
      try{
        const r = await fetch(API.remove(id), { method:'DELETE' });
        if (!r.ok) return alert('Не удалось удалить');
        await load();
      }catch{ alert('Ошибка сети'); }
    }

    function onEdit(row){
      editingId = row.id;
      formTitle.textContent = 'Редактирование #' + row.id;
      editForm.reset();
      fillSelect(selCategory,  loadDict('category'));
      fillSelect(selProject,   loadDict('project'));
      fillSelect(selCashbox,   loadDict('cashbox'));
      fillSelect(selContractor,loadDict('contractor'));
      editForm.elements['date'].value = row.date ? toISO(row.date) : '';
      editForm.elements['amount'].value = row.amount ?? '';
      editForm.elements['category'].value = row.category ?? '';
      editForm.elements['project'].value = row.project ?? '';
      editForm.elements['company_name'].value = row.company_name ?? '';
      editForm.elements['cashbox'].value = row.cashbox ?? '';
      editForm.elements['comment'].value = row.comment ?? '';
      formBack.style.display='flex';
    }

    // загрузка
    async function load(){
      tbody.innerHTML = '<tr><td>Загрузка...</td></tr>';
      try{
        const r = await fetch(API.list);
        const data = await r.json();
        all = Array.isArray(data) ? data : [];
        buildCashFilter();
        render();
      }catch(e){
        tbody.innerHTML = '<tr><td>Ошибка загрузки</td></tr>';
        console.error(e);
      }
    }

    // init
    load();
  </script>
</body>
</html>
