<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --brand:#b20054;
      --brand-dark:#82003d;
      --bg:#f4f5f7;
      --card:#fff;
      --thead:#fde7f3;
      --row-even:#f9eff6;
      --row-odd:#ffffff;
      --danger:#b42318;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:'Segoe UI',system-ui,Arial,sans-serif;margin:0;color:#111827}
    .container{max-width:1200px;margin:32px auto;background:var(--card);border-radius:18px;box-shadow:0 8px 36px #d0c6db42;padding:8px 0 24px 0}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:18px 22px 8px 22px}
    h1{margin:0;color:var(--brand);font-size:2rem;font-weight:800}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--brand);color:#fff;border:none;padding:10px 16px;border-radius:10px;font-size:.95rem;cursor:pointer;transition:.15s;box-shadow:0 2px 8px #b2005440}
    .btn:hover{background:var(--brand-dark)}
    .btn.outline{background:#fff;color:var(--brand);border:1px solid var(--brand);box-shadow:none}
    .btn.danger{background:var(--danger)}
    .btn.icon-only{padding:6px 10px;border-radius:8px}
    .box{padding:12px 20px}
    .hint{color:var(--muted);font-size:.9rem}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .pill input{margin:0}
    .panel{display:none;margin:10px 0 12px 0;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .panel .row{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .panel label{display:inline-flex;align-items:center;gap:8px;font-size:.95rem;color:#374151}

    .table-wrap{margin-top:10px;border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:72vh;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
    thead th{position:sticky;top:0;background:var(--thead);color:var(--brand);text-align:left;
      font-weight:700;padding:12px 10px;border-bottom:1px solid #f2c6df;z-index:1}
    tbody td{padding:10px 10px;border-bottom:1px solid #f3f4f6;font-size:0.98rem;vertical-align:top}
    tbody tr:nth-child(odd){background:var(--row-odd)}
    tbody tr:nth-child(even){background:var(--row-even)}
    tbody tr:hover{background:#fce7f3}
    .right{text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3e8ff;color:#6d28d9;font-size:.78rem}
    .soft{color:#6b7280}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .nowrap{white-space:nowrap}

    .form{display:flex;flex-wrap:wrap;gap:12px;align-items:end;margin-top:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .form label{font-size:.85rem;color:#374151}
    .form input,.form select,.form textarea{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;font-size:.95rem;min-width:180px}
    .form textarea{min-width:260px;min-height:38px;resize:vertical}

    @media (max-width:800px){
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .form{flex-direction:column;align-items:stretch}
      .table-wrap{max-height:60vh}
    }

    /* –Ω–µ–±–æ–ª—å—à–∏–µ –∏–∫–æ–Ω–∫–∏ */
    .ico{font-size:16px;line-height:1}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</h1>
      <div class="toolbar">
        <button id="settingsBtn" class="btn outline">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button id="refreshBtn" class="btn outline">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="addToggle" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </header>

    <div class="box">
      <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
      <div id="settingsPanel" class="panel">
        <div class="row">
          <label class="pill">
            <input type="checkbox" id="useDealSum">
            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É–º–º—É –∏–∑ —Å–¥–µ–ª–∫–∏ (bitrix_amount ‚Üí amount –ø—Ä–∏ —Å–≤—è–∑–∫–µ)</span>
          </label>
          <span class="hint">–•—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ ¬´—Å–∫—Ä–µ–ø–∫—É¬ª –≤ —Å—Ç—Ä–æ–∫–µ.</span>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
      <div id="addForm" style="display:none;">
        <div class="hint">–ú–∏–Ω–∏-—Ñ–æ—Ä–º–∞. –í –ë–î –ø–æ–ø–∞–¥—É—Ç —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏.</div>
        <form id="payment-form" class="form">
          <div class="field">
            <label>–î–∞—Ç–∞</label>
            <input type="date" name="date">
          </div>
          <div class="field">
            <label>–û–ø–µ—Ä–∞—Ü–∏—è</label>
            <input type="text" name="operation" placeholder="–ø—Ä–∏—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥">
          </div>
          <div class="field">
            <label>–°—Ç–∞—Ç—å—è</label>
            <input type="text" name="category" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–µ—á–∞—Ç—å, –º–∞—Ç–µ—Ä–∏–∞–ª—ã">
          </div>
          <div class="field">
            <label>–°—á–µ—Ç</label>
            <input type="text" name="account" placeholder="–∫–∞—Ä—Ç–∞/—Ä–∞—Å—á–µ—Ç–Ω—ã–π/–Ω–∞–ª–∏—á–Ω—ã–µ">
          </div>
          <div class="field">
            <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label>
            <input type="text" name="counterparty" placeholder="–∫–ª–∏–µ–Ω—Ç/–ø–æ—Å—Ç–∞–≤—â–∏–∫/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫">
          </div>
          <div class="field">
            <label>–ü—Ä–æ–µ–∫—Ç</label>
            <input type="text" name="project">
          </div>
          <div class="field">
            <label>–°—É–º–º–∞</label>
            <input type="number" step="0.01" name="amount" placeholder="0.00">
          </div>
          <div class="field" style="min-width:320px">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea name="comment" placeholder="–∑–∞–º–µ—Ç–∫–∞ –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏"></textarea>
          </div>
          <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <div class="table-wrap">
        <table id="payments-table">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
              <th>–°—Ç–∞—Ç—å—è</th>
              <th>–°—á–µ—Ç</th>
              <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
              <th>–°–¥–µ–ª–∫–∞</th>
              <th>–ü—Ä–æ–µ–∫—Ç</th>
              <th class="right">–°—É–º–º–∞</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:8px">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="count">0</span></div>
    </div>
  </div>

  <script>
    // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã API (—Å–º. —Ç–≤–æ–π –±—ç–∫–µ–Ω–¥) ---
    const API = {
      list: '/payments',
      create: '/payments',
      patch: id => `/payments/${id}/link`,
      linkBitrix: id => `/payments/${id}/link/bitrix`,
      remove: id => `/payments/${id}`,
    };

    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ) ---
    const settings = {
      useDealSum: false,
      load(){
        try {
          const raw = localStorage.getItem('finapp_settings');
          if (raw) Object.assign(this, JSON.parse(raw));
        } catch {}
      },
      save(){
        localStorage.setItem('finapp_settings', JSON.stringify({ useDealSum: this.useDealSum }));
      }
    };
    settings.load();

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    const $ = s => document.querySelector(s);
    const tbody = $('#tbody');
    const countEl = $('#count');
    const useDealSumEl = $('#useDealSum');
    useDealSumEl.checked = !!settings.useDealSum;
    useDealSumEl.addEventListener('change', () => {
      settings.useDealSum = useDealSumEl.checked;
      settings.save();
    });

    function money(v){
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v);
      if (Number.isNaN(n)) return String(v);
      return n.toFixed(2);
    }
    function prefer(...vals){
      for (const v of vals) { if (v !== undefined && v !== null && String(v).trim() !== '') return v; }
      return '';
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã ---
    let rows = [];
    async function loadPayments(){
      tbody.innerHTML = '<tr><td colspan="9">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
      try {
        const resp = await fetch(API.list);
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error('–û—Ç–≤–µ—Ç API –Ω–µ –º–∞—Å—Å–∏–≤');
        rows = data;
        renderRows();
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="9">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
      }
    }

    function renderRows(){
      tbody.innerHTML = '';
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="9">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        countEl.textContent = '0';
        return;
      }
      rows.forEach(row => {
        // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ–¥ —Ç–≤–æ–π –ø–æ—Ä—è–¥–æ–∫:
        const date = prefer(row.date, row.created_at);
        const operation = prefer(row.operation, row.type);
        const article = prefer(row.article, row.category);
        const account = prefer(row.account, row.cash, row.cashbox);
        const counterparty = prefer(row.counterparty, row.contractor, row.contact, row.company, row.client, row.supplier, row.employee);
        const dealTitle = prefer(row.bitrix_title, row.deal_title, row.deal_name, row.comment, row.note, row.deal_comment);
        const project = prefer(row.project, row.project_name, row.project_id);
        const amountRaw = settings.useDealSum && row.bitrix_amount !== undefined && row.bitrix_amount !== null
          ? row.bitrix_amount
          : prefer(row.amount, row.sum, row.value, row.bitrix_amount);
        const amount = money(amountRaw);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${date || ''}</td>
          <td>${operation || ''}</td>
          <td>${article || ''}</td>
          <td>${account || ''}</td>
          <td>${counterparty || ''}</td>
          <td>
            <div>${dealTitle || ''}</div>
            <div class="soft mono">ID: ${row.bitrix_deal_id || '-'}</div>
          </td>
          <td>${project || ''}</td>
          <td class="right">${amount}</td>
          <td>
            <div style="display:flex;gap:6px">
              <button class="btn icon-only" title="–°–≤—è–∑–∞—Ç—å —Å –ë–∏—Ç—Ä–∏–∫—Å">üìé</button>
              <button class="btn icon-only" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
              <button class="btn icon-only danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          </td>
        `;

        // –î–µ–π—Å—Ç–≤–∏—è
        const [linkBtn, editBtn, delBtn] = tr.querySelectorAll('button');

        linkBtn.addEventListener('click', async () => {
          const dealId = prompt('–í–≤–µ–¥–∏ ID —Å–¥–µ–ª–∫–∏ –ë–∏—Ç—Ä–∏–∫—Å:');
          if (!dealId) return;

          // 1) –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
          try{
            const resp = await fetch(API.linkBitrix(row.id), {
              method: 'POST',
              headers: { 'Content-Type':'application/json' },
              body: JSON.stringify({ dealId })
            });
            const result = await resp.json();
            if (!resp.ok) throw new Error(result?.error || '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∫–∏');

            // 2) –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ¬´–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É–º–º—É –∏–∑ —Å–¥–µ–ª–∫–∏¬ª –∏ —Å—É–º–º–∞ –µ—Å—Ç—å ‚Äî –∑–∞–ø–∏—à–µ–º –≤ amount
            const bitrixAmount = result?.updated?.bitrix_amount ?? result?.deal?.OPPORTUNITY;
            if (settings.useDealSum && bitrixAmount !== undefined && bitrixAmount !== null) {
              await fetch(API.patch(row.id), {
                method: 'PATCH',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ amount: bitrixAmount })
              });
            }
            await loadPayments();
          }catch(e){
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å: ' + e.message);
          }
        });

        editBtn.addEventListener('click', async () => {
          const newTitle = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ (–ø—É—Å—Ç–æ - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è):', prefer(row.title, row.name));
          const newAmount = prompt('–°—É–º–º–∞ (–ø—É—Å—Ç–æ - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è):', prefer(row.amount, row.sum, row.value));
          const patch = {};
          if (newTitle !== null && newTitle.trim() !== '') patch.title = newTitle.trim();
          if (newAmount !== null && newAmount.trim() !== '') patch.amount = Number(newAmount);
          if (!Object.keys(patch).length) return;
          try{
            const resp = await fetch(API.patch(row.id), {
              method:'PATCH',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(patch)
            });
            if (!resp.ok) throw new Error(await resp.text());
            await loadPayments();
          }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
        });

        delBtn.addEventListener('click', async () => {
          if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å #${row.id}?`)) return;
          try{
            const resp = await fetch(API.remove(row.id), { method:'DELETE' });
            if (!resp.ok) throw new Error(await resp.text());
            await loadPayments();
          }catch(e){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
        });

        tbody.appendChild(tr);
      });
      countEl.textContent = String(rows.length);
    }

    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ---
    $('#payment-form').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {};
      fd.forEach((v,k)=> body[k] = v);
      // —É–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ
      Object.keys(body).forEach(k => { if (String(body[k]).trim()==='') delete body[k]; });

      try{
        const resp = await fetch(API.create, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if (!resp.ok) throw new Error(await resp.text());
        e.target.reset();
        await loadPayments();
      }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
    });

    // --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ UI ---
    $('#addToggle').onclick = () => {
      const box = document.getElementById('addForm');
      box.style.display = (box.style.display === 'none' || !box.style.display) ? 'block' : 'none';
    };
    $('#refreshBtn').onclick = loadPayments;
    $('#settingsBtn').onclick = () => {
      const p = document.getElementById('settingsPanel');
      p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
    };

    // --- –°—Ç–∞—Ä—Ç ---
    loadPayments();
  </script>
</body>
</html>
