<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#b20054;
      --brand-dark:#83003e;
      --bg:#f4f5f7;
      --card:#fff;
      --thead:#fde7f3;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#14a44d;
      --bad:#e11d48;
      --zebra-inc: #eaf9ef;   /* –±—É–¥—É—â–∏–µ –î–û–•–û–î–´ (–ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω–∞—è –∑–µ–ª—ë–Ω–∞—è) */
      --zebra-exp: #fdeeee;   /* –±—É–¥—É—â–∏–µ –†–ê–°–•–û–î–´ (–ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω–∞—è –∫—Ä–∞—Å–Ω–∞—è) */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;color:#111827}
    .wrap{max-width:1200px;margin:26px auto 40px;background:transparent;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;color:var(--brand);font-size:40px;font-weight:800;letter-spacing:.5px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    select,input[type="date"]{height:42px;border-radius:10px;border:1px solid var(--border);padding:0 12px;background:#fff}
    .btn{
      background:var(--brand);border:none;color:#fff;border-radius:12px;height:42px;padding:0 16px;cursor:pointer;
      box-shadow:0 8px 28px #d0c6db42;transition:background .15s
    }
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--border)}
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary:hover{background:#f9fafb}

    .metrics{display:flex;gap:18px;align-items:center;margin:14px 0;color:#111827}
    .metrics .inc{color:var(--ok);font-weight:700}
    .metrics .exp{color:var(--bad);font-weight:700}

    .card{background:var(--card);border-radius:18px;box-shadow:0 8px 36px #d0c6db42}
    .toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px}

    table{width:100%;border-collapse:collapse}
    thead th{
      position:sticky;top:0;background:var(--thead);color:var(--brand);font-weight:700;
      padding:16px;border-bottom:1px solid var(--border);text-align:left
    }
    tbody td{padding:16px;border-bottom:1px solid var(--border);vertical-align:middle}

    .money{font-weight:700;white-space:nowrap}
    .money.inc{color:var(--ok)}
    .money.exp{color:var(--bad)}
    .badge{
      display:inline-block;background:#eef2ff;color:#4f46e5;border-radius:999px;padding:2px 10px;font-size:12px;font-weight:600;margin-left:6px
    }
    .row-future-inc{background:var(--zebra-inc)}
    .row-future-exp{background:var(--zebra-exp)}

    .act{display:flex;gap:10px}
    .iconbtn{
      width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;
      display:flex;align-items:center;justify-content:center;transition:transform .05s
    }
    .iconbtn:active{transform:scale(.98)}

    /* ---- –ú–æ–¥–∞–ª–∫–∏ ---- */
    .modal-back{
      position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:1000
    }
    .modal{
      background:#fff;border-radius:18px;padding:18px 18px 14px;min-width:300px;max-width:720px;width:92%;
      box-shadow:0 20px 60px rgba(0,0,0,.15)
    }
    .modal h3{margin:0 0 10px;color:#111827}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form .field{display:flex;flex-direction:column;gap:6px}
    .form input,.form select,.form textarea{
      border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px
    }
    .form textarea{min-height:100px}
    .modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    /* ---- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏) ---- */
    .settings{display:none;margin-top:12px;border:1px solid var(--border);border-radius:12px;padding:12px}
    .settings h4{margin:0 0 8px}
    .settings .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .settings textarea{width:100%;min-height:170px;border:1px solid var(--border);border-radius:10px;padding:8px}
    @media (max-width:980px){ .settings .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:640px){
      .form{grid-template-columns:1fr}
      .settings .grid{grid-template-columns:1fr}
    }
    .note{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>–§–∏–Ω–∞–Ω—Å—ã –°—Ç–∞–ª–∫–µ—Ä</h1>
      <div class="row">
        <button id="settingsBtn" class="btn secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
      </div>
    </header>

    <div class="card toolbar">
      <div class="row">
        <select id="opFilter">
          <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
          <option value="income">–¢–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥—ã</option>
          <option value="expense">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</option>
          <option value="planned">–ü–ª–∞–Ω (–±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)</option>
        </select>
        <select id="cashFilter">
          <option value="all">–í—Å–µ –∫–∞—Å—Å—ã</option>
        </select>
        <input id="fromDate" type="date" />
        <input id="toDate" type="date" />
        <button id="resetBtn" class="btn secondary">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
      <div class="metrics">
        <span>–î–æ—Ö–æ–¥: <span id="incSum" class="inc">0 ‚ÇΩ</span></span>
        <span>‚Ä¢</span>
        <span>–†–∞—Å—Ö–æ–¥: <span id="expSum" class="exp">0 ‚ÇΩ</span></span>
        <span>‚Ä¢</span>
        <span>–ë–∞–ª–∞–Ω—Å: <b id="balSum">0 ‚ÇΩ</b></span>
      </div>
    </div>

    <div class="card" style="margin-top:14px;overflow:auto">
      <table>
        <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
          <th>–°—Ç–∞—Ç—å—è/–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–°–¥–µ–ª–∫–∞</th>
          <th>–ü—Ä–æ–µ–∫—Ç</th>
          <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
          <th>–°—á—ë—Ç/–∫–∞—Å—Å—ã</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody id="tbody"><tr><td>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
      </table>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏) -->
    <div id="settingsPanel" class="settings card">
      <h4>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)</h4>
      <div class="grid">
        <div>
          <div class="note">–°—Ç–∞—Ç—å–∏</div>
          <textarea id="dictCategory"></textarea>
        </div>
        <div>
          <div class="note">–ü—Ä–æ–µ–∫—Ç—ã</div>
          <textarea id="dictProject"></textarea>
        </div>
        <div>
          <div class="note">–ö–∞—Å—Å—ã/—Å—á–µ—Ç–∞</div>
          <textarea id="dictCashbox"></textarea>
        </div>
        <div>
          <div class="note">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã (–∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–Ω—Ç–∞–∫—Ç—ã/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)</div>
          <textarea id="dictContractor" placeholder="–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveDicts" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <span class="note">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–∞—Ö –º–æ–¥–∞–ª–æ–∫.</span>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal-back" id="editBack">
      <div class="modal">
        <h3 id="editTitle">–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h3>
        <div class="form">
          <div class="field">
            <label>–î–∞—Ç–∞</label>
            <input id="f_date" type="date" />
          </div>
          <div class="field">
            <label>–°—É–º–º–∞</label>
            <input id="f_amount" type="number" step="0.01" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000" />
          </div>
          <div class="field">
            <label>–°—Ç–∞—Ç—å—è</label>
            <select id="f_category"></select>
          </div>
          <div class="field">
            <label>–ü—Ä–æ–µ–∫—Ç</label>
            <select id="f_project"></select>
          </div>
          <div class="field">
            <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label>
            <select id="f_contractor"></select>
          </div>
          <div class="field">
            <label>–°—á—ë—Ç/–∫–∞—Å—Å–∞</label>
            <select id="f_cashbox"></select>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <input id="f_comment" type="text" placeholder="–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" />
          </div>
        </div>
        <div class="footer">
          <button id="editCancel" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
          <button id="editSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–≤—è–∑–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å -->
    <div class="modal-back" id="bitrixBack">
      <div class="modal">
        <h3>–°–≤—è–∑–∞—Ç—å —Å –ë–∏—Ç—Ä–∏–∫—Å</h3>
        <div class="form" style="grid-template-columns:1fr">
          <div class="field">
            <label>ID —Å–¥–µ–ª–∫–∏</label>
            <input id="dealIdInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1234" />
          </div>
          <div class="field">
            <label style="display:flex;gap:10px;align-items:center">
              <input id="overwriteAmount" type="checkbox" />
              <span>–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É–º–º—É –∏–∑ —Å–¥–µ–ª–∫–∏</span>
            </label>
          </div>
          <div class="note">
            –ë—É–¥–µ—Ç –ø–æ–¥—Ç—è–Ω—É—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ (TITLE). –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è ‚Äî —Å—É–º–º–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–º–µ–Ω–∏—Ç—Å—è –Ω–∞ OPPORTUNITY –∏–∑ —Å–¥–µ–ª–∫–∏.
          </div>
        </div>
        <div class="footer">
          <button id="bitrixCancel" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
          <button id="bitrixLink" class="btn">–°–≤—è–∑–∞—Ç—å</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ===== API =====
    const API = {
      list:'/payments',
      create:'/payments',
      update(id){return `/payments/${id}`},
      remove(id){return `/payments/${id}`},
      patch(id){return `/payments/${id}/link`},
      linkBitrix(id){return `/payments/${id}/link/bitrix`}
    };

    // ===== helpers =====
    const el = s => document.querySelector(s);
    const fmtMoney = n => {
      const v = Number(n);
      if (Number.isNaN(v)) return '0 ‚ÇΩ';
      return v.toLocaleString('ru-RU',{minimumFractionDigits:0}) + ' ‚ÇΩ';
    };
    const toISO = s => {
      if(!s) return null;
      const d = new Date(s);
      if (isNaN(d)) return null;
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${yy}-${mm}-${dd}`;
    };
    const todayISO = (()=>{const d=new Date();const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');return `${d.getFullYear()}-${mm}-${dd}`})();

    // ===== state =====
    let all = [];
    let editingId = null;
    let linkRowId = null;

    // ===== settings (local dicts) =====
    const loadDict = k => { try{ return JSON.parse(localStorage.getItem('dict_'+k) || '[]'); }catch(_){ return []; } };
    const saveDict = (k,arr)=> localStorage.setItem('dict_'+k, JSON.stringify(arr));
    const normLines = s => String(s||'').split('\n').map(x=>x.trim()).filter(Boolean);

    function fillDictTextareas(){
      el('#dictCategory').value  = loadDict('category').join('\n');
      el('#dictProject').value   = loadDict('project').join('\n');
      el('#dictCashbox').value   = loadDict('cashbox').join('\n');
      el('#dictContractor').value= loadDict('contractor').join('\n');
    }

    function saveDicts(){
      saveDict('category',  normLines(el('#dictCategory').value));
      saveDict('project',   normLines(el('#dictProject').value));
      saveDict('cashbox',   normLines(el('#dictCashbox').value));
      saveDict('contractor',normLines(el('#dictContractor').value));
      alert('–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      buildSelects();
    }

    function buildSelects(){
      const fill = (sel, arr) => {
        sel.innerHTML = '<option value="">‚Äî</option>' + arr.map(v=>`<option>${v}</option>`).join('');
      };
      fill(el('#f_category'),   loadDict('category'));
      fill(el('#f_project'),    loadDict('project'));
      fill(el('#f_cashbox'),    loadDict('cashbox'));
      fill(el('#f_contractor'), loadDict('contractor'));

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Å—Å–µ
      const cashSel = el('#cashFilter');
      const current = cashSel.value || 'all';
      cashSel.innerHTML = '<option value="all">–í—Å–µ –∫–∞—Å—Å—ã</option>' + loadDict('cashbox').map(v=>`<option>${v}</option>`).join('');
      cashSel.value = current;
    }

    // ===== UI toggles =====
    function toggleSettings(){
      const panel = el('#settingsPanel');
      const shown = panel.style.display !== 'none' && panel.style.display !== '';
      if (shown){
        panel.style.display = 'none';
      }else{
        fillDictTextareas();
        panel.style.display = 'block';
      }
    }

    function openEditModal(row){
      editingId = row?.id ?? null;
      el('#editTitle').textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏' : '–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è';
      el('#f_date').value    = row?.date ? toISO(row.date) : toISO(new Date());
      el('#f_amount').value  = row?.amount ?? '';
      el('#f_category').value= row?.category ?? '';
      el('#f_project').value = row?.project ?? '';
      el('#f_contractor').value = row?.contractor ?? '';
      el('#f_cashbox').value = row?.cashbox ?? '';
      el('#f_comment').value = row?.comment ?? '';
      el('#editBack').style.display = 'flex';
    }
    function closeEdit(){ el('#editBack').style.display = 'none'; editingId=null; }

    function openBitrixModal(rowId){
      linkRowId = rowId;
      el('#dealIdInput').value = '';
      el('#overwriteAmount').checked = false;
      el('#bitrixBack').style.display = 'flex';
    }
    function closeBitrix(){ el('#bitrixBack').style.display = 'none'; linkRowId=null; }

    // ===== render =====
    function isFuture(dateISO){
      if (!dateISO) return false;
      return dateISO > todayISO;
    }

    function render(){
      const tbody = el('#tbody');
      if (!Array.isArray(all)){ tbody.innerHTML='<tr><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'; return; }

      // —Ñ–∏–ª—å—Ç—Ä—ã
      const op = el('#opFilter').value;
      const cash = el('#cashFilter').value;
      const from = el('#fromDate').value || null;
      const to   = el('#toDate').value   || null;

      const filtered = all.filter(r=>{
        // –¥–∞—Ç–∞
        const d = toISO(r.date);
        if (from && (!d || d < from)) return false;
        if (to && (!d || d > to)) return false;
        // –∫–∞—Å—Å–∞
        if (cash !== 'all' && r.cashbox !== cash) return false;
        // –æ–ø–µ—Ä–∞—Ü–∏—è
        if (op === 'income'  && !(Number(r.amount) > 0)) return false;
        if (op === 'expense' && !(Number(r.amount) < 0)) return false;
        if (op === 'planned' && !isFuture(toISO(r.date))) return false;
        return true;
      });

      // –∞–≥—Ä–µ–≥–∞—Ç—ã
      let inc=0,exp=0;
      for (const r of filtered){
        const a = Number(r.amount)||0;
        if (a>0) inc+=a; else exp+=Math.abs(a);
      }
      el('#incSum').textContent = fmtMoney(inc);
      el('#expSum').textContent = fmtMoney(exp);
      el('#balSum').textContent = fmtMoney(inc-exp);

      if (!filtered.length){
        tbody.innerHTML = '<tr><td style="padding:18px">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(r=>{
        const dISO = toISO(r.date);
        const future = isFuture(dISO);
        const amount = Number(r.amount)||0;
        const moneyCls = amount>=0 ? 'inc' : 'exp';
        const zebraCls = future ? (amount>=0?'row-future-inc':'row-future-exp') : '';
        const planBadge = future ? '<span class="badge">–ø–ª–∞–Ω</span>' : '';

        const dealTitle = r.bitrix_title
            ? r.bitrix_title
            : (r.bitrix_deal_id ? `–°–¥–µ–ª–∫–∞ #${r.bitrix_deal_id}` : '–°–≤—è–∑–∞—Ç—å‚Ä¶');

        return `
          <tr class="${zebraCls}">
            <td>${dISO??''} ${planBadge}</td>
            <td class="money ${moneyCls}">${amount>=0?'+':''}${fmtMoney(Math.abs(amount))}</td>
            <td>${r.category ?? ''}</td>
            <td><a href="javascript:void(0)" class="link-bx" data-id="${r.id}">${dealTitle}</a></td>
            <td>${r.project ?? ''}</td>
            <td>${r.contractor ?? ''}</td>
            <td>${r.cashbox ?? ''}</td>
            <td>
              <div class="act">
                <button class="iconbtn btn-edit"  data-id="${r.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button class="iconbtn btn-link"  data-id="${r.id}" title="–°–≤—è–∑–∞—Ç—å —Å –ë–∏—Ç—Ä–∏–∫—Å">üîó</button>
                <button class="iconbtn btn-del"   data-id="${r.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // –¥–µ–π—Å—Ç–≤–∏—è
      tbody.querySelectorAll('.btn-edit').forEach(b=>{
        b.addEventListener('click', ()=>{
          const row = all.find(x=>String(x.id)===b.dataset.id);
          openEditModal(row);
        });
      });
      tbody.querySelectorAll('.btn-del').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id=b.dataset.id;
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
          try{
            const r = await fetch(API.remove(id),{method:'DELETE'});
            if(!r.ok) throw new Error('delete failed');
            load();
          }catch(e){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); console.error(e); }
        });
      });
      tbody.querySelectorAll('.btn-link,.link-bx').forEach(b=>{
        b.addEventListener('click', ()=> openBitrixModal(b.dataset.id));
      });
    }

    // ===== CRUD =====
    async function load(){
      try{
        const r = await fetch(API.list);
        const data = await r.json();
        all = Array.isArray(data) ? data : [];
        buildSelects();
        render();
      }catch(e){
        el('#tbody').innerHTML = '<tr><td style="padding:18px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        console.error(e);
      }
    }

    async function saveEdit(){
      const body = {
        date: el('#f_date').value || todayISO,
        amount: Number(el('#f_amount').value || 0),
        category: el('#f_category').value || null,
        project: el('#f_project').value || null,
        contractor: el('#f_contractor').value || null,
        cashbox: el('#f_cashbox').value || null,
        comment: el('#f_comment').value || null
      };
      try{
        const r = await fetch(editingId?API.update(editingId):API.create,{
          method: editingId?'PUT':'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if(!r.ok) throw new Error('save failed');
        closeEdit();
        load();
      }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
    }

    async function linkBitrix(){
      const id = linkRowId;
      const dealId = el('#dealIdInput').value.trim();
      const overwrite = el('#overwriteAmount').checked;
      if (!id || !dealId){ alert('–£–∫–∞–∂–∏—Ç–µ ID —Å–¥–µ–ª–∫–∏'); return; }
      try{
        const r = await fetch(API.linkBitrix(id), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ dealId, overwriteAmount: overwrite })
        });
        if(!r.ok) throw new Error('bitrix link failed');
        closeBitrix();
        load();
      }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å'); }
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      // –∫–Ω–æ–ø–∫–∏ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏
      el('#settingsBtn').addEventListener('click', toggleSettings);
      el('#addBtn').addEventListener('click', ()=>openEditModal(null));
      el('#resetBtn').addEventListener('click', ()=>{
        el('#opFilter').value='all';
        el('#cashFilter').value='all';
        el('#fromDate').value='';
        el('#toDate').value='';
        render();
      });

      // –º–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      el('#editCancel').addEventListener('click', closeEdit);
      el('#editSave').addEventListener('click', saveEdit);

      // –º–æ–¥–∞–ª–∫–∞ –±–∏—Ç—Ä–∏–∫—Å
      el('#bitrixCancel').addEventListener('click', closeBitrix);
      el('#bitrixLink').addEventListener('click', linkBitrix);

      // —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
      el('#saveDicts').addEventListener('click', saveDicts);

      // —Ñ–∏–ª—å—Ç—Ä—ã ‚Üí —Ä–µ—Ä–µ–Ω–¥–µ—Ä
      ['#opFilter','#cashFilter','#fromDate','#toDate'].forEach(s=>{
        el(s).addEventListener('change', render);
      });

      // —Å—Ç–∞—Ä—Ç
      buildSelects();
      load();
    });
  </script>
</body>
</html>
