<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>fin-uchet — проверка фронта</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 980px; margin: 24px auto; }
    h1 { margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; }
    pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #f0f0f0; padding: 8px 10px; text-align: left; }
    th { background: #f8f8f8; }
    .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .controls { margin: 16px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .error { color: crimson; margin-top: 8px; }
    input, select, textarea, button { padding: 10px 12px; border: 1px solid #dcdcdc; border-radius: 8px; font: inherit; }
    button { cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.ghost { background: #fff; color: #111; }
    small.muted { color: #888; }
    .hint { font-size: 12px; color: #666; margin-top: -6px; }
    .danger { background:#ffefef; }
    .actions { display: flex; gap: 6px; }
  </style>
</head>
<body>
  <h1>fin-uchet — проверка фронта</h1>

  <div class="grid">
    <div class="card">
      <h3>Health</h3>
      <pre id="health">—</pre>
    </div>
    <div class="card">
      <h3>DB</h3>
      <pre id="db">—</pre>
    </div>
  </div>

  <div class="controls">
    <button id="btnReload">Обновить</button>
    <span id="loading" style="display:none;">Загрузка…</span>
    <div id="error" class="error"></div>
  </div>

  <div class="card" style="margin:16px 0;">
    <h3 style="margin-top:0;">Платёж</h3>
    <div class="row" style="margin-bottom:10px;">
      <div>
        <label>Дата</label><br />
        <input id="inDate" type="date" />
        <div class="hint">Если пусто - возьмём сегодня</div>
      </div>
      <div>
        <label>Сумма</label><br />
        <input id="inAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
      </div>
      <div>
        <label>Категория</label><br />
        <select id="inCategory">
          <option value="">— выбрать —</option>
          <option>Выручка</option>
          <option>Расход</option>
          <option>Перевод</option>
          <option>Зарплата</option>
          <option>Налоги</option>
          <option>Тест</option>
        </select>
      </div>
      <div>
        <label>Комментарий</label><br />
        <input id="inComment" type="text" placeholder="необязательно" />
      </div>
    </div>
    <div class="controls">
      <button id="btnAdd" class="primary">Сохранить платёж</button>
      <button id="btnCancel" class="ghost" style="display:none;">Отменить редактирование</button>
      <small class="muted">Обязательные поля: дата, сумма, категория</small>
    </div>
  </div>

  <h3>Payments</h3>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Дата</th>
          <th>Сумма</th>
          <th>Категория</th>
          <th>Комментарий</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" style="text-align:center; color:#777;">Пусто</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const show = (n, v) => n.style.display = v ? '' : 'none';
    const set = (n, v) => n.textContent = v;

    let editingId = null; // если не null — редактируем этот id

    // Форматтеры
    const fmtDate = (iso) => {
      if (!iso) return '';
      const d = new Date(iso);
      return isNaN(d.getTime()) ? iso : d.toLocaleDateString('ru-RU');
    };
    const fmtMoney = (v) => {
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v);
      return isNaN(n)
        ? String(v)
        : n.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };
    const toInputDate = (iso) => String(iso || '').slice(0,10);

    async function getJSON(path, options) {
      const r = await fetch(path, options);
      if (!r.ok) throw new Error(`API ${r.status}: ${await r.text()}`);
      const ct = r.headers.get('content-type') || '';
      return ct.includes('application/json') ? r.json() : r.text();
    }

    async function loadAll() {
      show(el('loading'), true);
      set(el('error'), '');
      try {
        const [h, d, p] = await Promise.all([
          getJSON('/health'),
          getJSON('/dbcheck'),
          getJSON('/payments'),
        ]);
        set(el('health'), JSON.stringify(h));
        set(el('db'), JSON.stringify(d));
        renderPayments(Array.isArray(p) ? p : []);
        if (!editingId) prefillDate();
      } catch (e) {
        set(el('error'), e.message || 'Ошибка загрузки');
      } finally {
        show(el('loading'), false);
      }
    }

    function ensureCategoryOption(value) {
      const sel = el('inCategory');
      if (!value) return;
      if ([...sel.options].some(o => o.value === value)) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      sel.appendChild(opt);
    }

    function renderPayments(items) {
      const tbody = el('rows');
      tbody.innerHTML = '';
      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#777;">Платежей нет</td></tr>';
        return;
      }
      for (const p of items) {
        const tr = document.createElement('tr');
        tr.dataset.id = p.id;
        tr.innerHTML = `
          <td>${p.id ?? ''}</td>
          <td>${fmtDate(p.date)}</td>
          <td>${fmtMoney(p.amount)}</td>
          <td>${p.category ?? ''}</td>
          <td>${p.comment ?? ''}</td>
          <td class="actions">
            <button data-edit="${p.id}">Редактировать</button>
            <button data-del="${p.id}">Удалить</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // ВАЖНО: делегирование — один обработчик на tbody
      tbody.onclick = async (e) => {
        const btn = e.target.closest('button[data-edit], button[data-del]');
        if (!btn) return;
        const id = Number(btn.dataset.edit || btn.dataset.del);
        if (!id) return;

        if (btn.hasAttribute('data-del')) {
          if (!confirm(`Удалить платёж #${id}?`)) return;
          await deletePayment(id, btn.closest('tr'));
          return;
        }

        // Редактирование
        const row = [...tbody.querySelectorAll('tr')].find(tr => Number(tr.dataset.id) === id);
        // найдём объект p по ячейкам (или можно запросить весь список заново)
        const cells = row.querySelectorAll('td');
        const p = {
          id,
          date: toInputDate(cells[1]?.textContent?.trim() ? new Date(cells[1].textContent.trim().split('.').reverse().join('-')).toISOString() : ''),
          amount: cells[2]?.textContent?.trim().replace(/\s/g,'').replace(',','.') || '',
          category: cells[3]?.textContent?.trim() || '',
          comment: cells[4]?.textContent?.trim() || ''
        };
        startEdit(id, p);
      };
    }

    function startEdit(id, p) {
      editingId = id;
      el('inDate').value = toInputDate(p?.date);
      el('inAmount').value = (p?.amount ?? '').toString().replace('.', ',');
      ensureCategoryOption(p?.category);
      el('inCategory').value = p?.category ?? '';
      el('inComment').value = p?.comment ?? '';
      el('btnAdd').textContent = 'Обновить платёж';
      show(el('btnCancel'), true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
      editingId = null;
      el('btnAdd').textContent = 'Сохранить платёж';
      show(el('btnCancel'), false);
      el('inAmount').value = '';
      el('inComment').value = '';
      prefillDate();
    }

    async function deletePayment(id, row) {
      try {
        row?.classList.add('danger');
        const r = await fetch(`/payments/${id}`, { method: 'DELETE' });
        if (r.status !== 204) {
          const text = await r.text();
          throw new Error(`API ${r.status}: ${text}`);
        }
        if (editingId === id) cancelEdit();
        await loadAll();
      } catch (e) {
        set(el('error'), e.message || 'Ошибка удаления');
        row?.classList.remove('danger');
      }
    }

    function prefillDate() {
      const today = new Date().toISOString().slice(0,10);
      if (!el('inDate').value) el('inDate').value = today;
    }

    async function addOrUpdatePayment() {
      show(el('loading'), true);
      set(el('error'), '');
      try {
        const date = el('inDate').value || new Date().toISOString().slice(0,10);
        const amountRaw = el('inAmount').value.replace(',', '.').trim();
        const amount = Number(amountRaw);
        const category = el('inCategory').value.trim();
        const comment = el('inComment').value.trim() || null;

        if (!date || !amountRaw || isNaN(amount) || !category) {
          throw new Error('Заполните: дату, сумму (число) и категорию');
        }

        if (editingId) {
          await getJSON(`/payments/${editingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, amount, category, comment })
          });
          cancelEdit();
        } else {
          await getJSON('/payments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, amount, category, comment })
          });
          el('inAmount').value = '';
          el('inComment').value = '';
        }

        await loadAll();
      } catch (e) {
        set(el('error'), e.message || 'Ошибка сохранения');
      } finally {
        show(el('loading'), false);
      }
    }

    el('btnReload').addEventListener('click', loadAll);
    el('btnAdd').addEventListener('click', addOrUpdatePayment);
    el('btnCancel').addEventListener('click', cancelEdit);
    loadAll();
  </script>
</body>
</html>
